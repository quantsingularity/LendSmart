version: '3.8'

services:
    # Main application
    app:
        build:
            context: .
            dockerfile: Dockerfile
            target: development
        container_name: lendsmart-backend
        restart: unless-stopped
        ports:
            - '3000:3000'
            - '9229:9229' # Debug port
        environment:
            - NODE_ENV=development
            - PORT=3000
            - MONGODB_URI=mongodb://mongo:27017/lendsmart_dev
            - REDIS_URL=redis://redis:6379
            - JWT_SECRET=dev-jwt-secret-change-in-production
            - JWT_EXPIRE=24h
            - REFRESH_TOKEN_SECRET=dev-refresh-secret-change-in-production
            - REFRESH_TOKEN_EXPIRE=7d
            - ENCRYPTION_KEY=dev-encryption-key-32-chars-long
            - LOG_LEVEL=debug
            - CORS_ORIGIN=http://localhost:3001
            - RATE_LIMIT_WINDOW_MS=900000
            - RATE_LIMIT_MAX_REQUESTS=100
            - SESSION_SECRET=dev-session-secret-change-in-production
            - COOKIE_SECURE=false
            - TRUST_PROXY=true
        volumes:
            - .:/app
            - /app/node_modules
            - ./logs:/app/logs
        depends_on:
            - mongo
            - redis
        networks:
            - lendsmart-network
        command: npm run dev
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # MongoDB database
    mongo:
        image: mongo:6.0
        container_name: lendsmart-mongo
        restart: unless-stopped
        ports:
            - '27017:27017'
        environment:
            - MONGO_INITDB_ROOT_USERNAME=admin
            - MONGO_INITDB_ROOT_PASSWORD=admin123
            - MONGO_INITDB_DATABASE=lendsmart_dev
        volumes:
            - mongo_data:/data/db
            - ./scripts/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
        networks:
            - lendsmart-network
        healthcheck:
            test: ['CMD', 'mongosh', '--eval', "db.adminCommand('ping')"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # Redis cache
    redis:
        image: redis:7-alpine
        container_name: lendsmart-redis
        restart: unless-stopped
        ports:
            - '6379:6379'
        command: redis-server --appendonly yes --requirepass redis123
        volumes:
            - redis_data:/data
        networks:
            - lendsmart-network
        healthcheck:
            test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
            interval: 30s
            timeout: 10s
            retries: 3

    # Nginx reverse proxy
    nginx:
        image: nginx:alpine
        container_name: lendsmart-nginx
        restart: unless-stopped
        ports:
            - '80:80'
            - '443:443'
        volumes:
            - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
            - ./nginx/ssl:/etc/nginx/ssl:ro
            - ./logs/nginx:/var/log/nginx
        depends_on:
            - app
        networks:
            - lendsmart-network
        healthcheck:
            test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost/health']
            interval: 30s
            timeout: 10s
            retries: 3

    # Elasticsearch for logging
    elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.8.0
        container_name: lendsmart-elasticsearch
        restart: unless-stopped
        environment:
            - discovery.type=single-node
            - xpack.security.enabled=false
            - 'ES_JAVA_OPTS=-Xms512m -Xmx512m'
        ports:
            - '9200:9200'
        volumes:
            - elasticsearch_data:/usr/share/elasticsearch/data
        networks:
            - lendsmart-network
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:9200/_cluster/health']
            interval: 30s
            timeout: 10s
            retries: 3

    # Kibana for log visualization
    kibana:
        image: docker.elastic.co/kibana/kibana:8.8.0
        container_name: lendsmart-kibana
        restart: unless-stopped
        ports:
            - '5601:5601'
        environment:
            - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
        depends_on:
            - elasticsearch
        networks:
            - lendsmart-network
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:5601/api/status']
            interval: 30s
            timeout: 10s
            retries: 3

    # Prometheus for metrics
    prometheus:
        image: prom/prometheus:latest
        container_name: lendsmart-prometheus
        restart: unless-stopped
        ports:
            - '9090:9090'
        volumes:
            - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
            - prometheus_data:/prometheus
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--web.console.libraries=/etc/prometheus/console_libraries'
            - '--web.console.templates=/etc/prometheus/consoles'
            - '--storage.tsdb.retention.time=200h'
            - '--web.enable-lifecycle'
        networks:
            - lendsmart-network
        healthcheck:
            test:
                [
                    'CMD',
                    'wget',
                    '--quiet',
                    '--tries=1',
                    '--spider',
                    'http://localhost:9090/-/healthy',
                ]
            interval: 30s
            timeout: 10s
            retries: 3

    # Grafana for monitoring dashboards
    grafana:
        image: grafana/grafana:latest
        container_name: lendsmart-grafana
        restart: unless-stopped
        ports:
            - '3001:3000'
        environment:
            - GF_SECURITY_ADMIN_PASSWORD=admin123
            - GF_USERS_ALLOW_SIGN_UP=false
        volumes:
            - grafana_data:/var/lib/grafana
            - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
            - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
        depends_on:
            - prometheus
        networks:
            - lendsmart-network
        healthcheck:
            test:
                [
                    'CMD',
                    'wget',
                    '--quiet',
                    '--tries=1',
                    '--spider',
                    'http://localhost:3000/api/health',
                ]
            interval: 30s
            timeout: 10s
            retries: 3

    # Jaeger for distributed tracing
    jaeger:
        image: jaegertracing/all-in-one:latest
        container_name: lendsmart-jaeger
        restart: unless-stopped
        ports:
            - '16686:16686'
            - '14268:14268'
        environment:
            - COLLECTOR_OTLP_ENABLED=true
        networks:
            - lendsmart-network
        healthcheck:
            test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:16686/']
            interval: 30s
            timeout: 10s
            retries: 3

    # Test database for integration tests
    mongo-test:
        image: mongo:6.0
        container_name: lendsmart-mongo-test
        restart: 'no'
        ports:
            - '27018:27017'
        environment:
            - MONGO_INITDB_DATABASE=lendsmart_test
        volumes:
            - mongo_test_data:/data/db
        networks:
            - lendsmart-network
        profiles:
            - testing

    # Redis for testing
    redis-test:
        image: redis:7-alpine
        container_name: lendsmart-redis-test
        restart: 'no'
        ports:
            - '6380:6379'
        command: redis-server --appendonly no
        networks:
            - lendsmart-network
        profiles:
            - testing

    # Test runner
    test-runner:
        build:
            context: .
            dockerfile: Dockerfile
            target: testing
        container_name: lendsmart-test-runner
        environment:
            - NODE_ENV=test
            - MONGODB_URI=mongodb://mongo-test:27017/lendsmart_test
            - REDIS_URL=redis://redis-test:6379
            - JWT_SECRET=test-jwt-secret
            - ENCRYPTION_KEY=test-encryption-key-32-chars-long
        volumes:
            - .:/app
            - /app/node_modules
            - ./coverage:/app/coverage
        depends_on:
            - mongo-test
            - redis-test
        networks:
            - lendsmart-network
        profiles:
            - testing
        command: npm test

    # Load testing with Artillery
    load-test:
        image: artilleryio/artillery:latest
        container_name: lendsmart-load-test
        volumes:
            - ./tests/load:/scripts
            - ./reports:/reports
        depends_on:
            - app
        networks:
            - lendsmart-network
        profiles:
            - load-testing
        command: run /scripts/load-test.yml --output /reports/load-test-report.json

    # Security scanning with OWASP ZAP
    security-scan:
        image: owasp/zap2docker-stable
        container_name: lendsmart-security-scan
        volumes:
            - ./reports:/zap/wrk
        depends_on:
            - app
        networks:
            - lendsmart-network
        profiles:
            - security-testing
        command: zap-baseline.py -t http://app:3000 -J zap-report.json

volumes:
    mongo_data:
        driver: local
    mongo_test_data:
        driver: local
    redis_data:
        driver: local
    elasticsearch_data:
        driver: local
    prometheus_data:
        driver: local
    grafana_data:
        driver: local

networks:
    lendsmart-network:
        driver: bridge
        ipam:
            config:
                - subnet: 172.20.0.0/16
